FROM rust AS builder

# nginx:alpine contains NGINX_VERSION environment variable, like so:
ENV NGINX_VERSION 1.29.1

# Module version
ENV MOD_VERSION 0.1.1

# Download sources
RUN wget "http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz" -O nginx.tar.gz && \
  wget "https://github.com/nginx/nginx-acme/releases/download/v0.1.1/nginx-acme-${MOD_VERSION}.tar.gz" -O module.tar.gz

# For latest build deps, see https://github.com/nginxinc/docker-nginx/blob/master/mainline/alpine/Dockerfile
RUN apt-get update && \
  apt-get install -y libclang-cpp19* libclang-common-19-dev libclang-19-dev

# Reuse same cli arguments as the nginx:alpine image used to build
RUN CONFARGS=$(nginx -V 2>&1 | sed -n -e 's/^.*arguments: //p') \
  tar -zxf nginx.tar.gz && \
  tar -xzf "module.tar.gz" && \
  MOD_DIR="$(pwd)/nginx-acme-${MOD_VERSION}" && \
  cd nginx-${NGINX_VERSION} && \
  ./configure --with-compat --with-http_ssl_module && \
  make && \
  cd ${MOD_DIR} && \
  export NGINX_BUILD_DIR=$(realpath ../nginx-${NGINX_VERSION}/objs) && \
  cargo build --release

FROM nginx
# Extract the dynamic module from the builder image
ENV MOD_VERSION 0.1.1
COPY --from=builder nginx-acme-${MOD_VERSION}/target/release/libnginx_acme.so /usr/lib/nginx/modules/objs/ngx_http_acme_module.so
# Remember to load_module in config
RUN sed -i '1i load_module /usr/lib/nginx/modules/objs/ngx_http_acme_module.so;' /etc/nginx/nginx.conf
